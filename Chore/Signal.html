<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Chore::Signal
  
    &mdash; Documentation by YARD 0.9.25
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Chore::Signal";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Chore.html" title="Chore (module)">Chore</a></span></span>
     &raquo; 
    <span class="title">Signal</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Chore::Signal
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Chore::Signal</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/chore/signal.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Provides smarter signal handling capabilities than Ruby&#39;s built-in
Signal class.  Specifically it runs callbacks in a separate thread since:</p>

<pre class="code ruby"><code class="ruby">(1) Ruby 2.0 cannot obtain locks in the main Signal thread
(2) Doing so can result in deadlocks in Ruby 1.9.x.</code></pre>

<p>Ruby&#39;s core implementation can be found at: <a
href="http://ruby-doc.org/core-1.9.3/Signal.html">ruby-doc.org/core-1.9.3/Signal.html</a></p>

<h2 id="label-Differences">Differences</h2>

<p>There are a few important differences with the way signals trapped through
this class behave than through Ruby&#39;s Signal class.</p>

<h3 id="label-Sequential+processing">Sequential processing</h3>

<p>In Ruby, signals are interrupt-driven â€“ the thread is executing at the time
will be interrupted at that point in the call stack and start executing the
signal handler.  This increases the potential for deadlocks if mutexes are
in use by both the thread and the signal handler.</p>

<p>In Chore, signal handlers are executed sequentially.  When a handler is
started, it must complete before the next signal is processed.  These
handlers are also executed in their own thread and, therefore, will compete
for resources with the rest of the application.</p>

<h3 id="label-Forking">Forking</h3>

<p>In Ruby, forking does not disrupt the ability to process signals.  Signals
trapped in the master process will continue to be trapped in forked child
processes.</p>

<p>In Chore, this is not the case.  When a process is forked, any trapped
signals will no longer get processed.  This is because the thread that
processes those incoming signals gets killed.</p>

<p>In order to process these signals, `Chore::Signal.reset` must be called,
followed by additional calls to re-register those signal handlers.</p>

<h2 id="label-Signal+ordering">Signal ordering</h2>

<p>It is important to note that in Ruby, signals are essentially processed as
LIFO (Last-In, First-Out) since they are interrupt driven.  Similar
behaviors is present in Chore&#39;s implementation.</p>

<p>Having LIFO behavior is the reason why this class uses a queue for tracking
the list of incoming signals, instead of writing them out to a pipe.</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="PRIORITIES-constant" class="">PRIORITIES =
          <div class="docstring">
  <div class="discussion">
    
<p>The priorities of signals to handle.  If not defined, the signal is
considered high-priority.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>CHLD</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='symbol'>:secondary</span>
<span class='rbrace'>}</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset-class_method" title="reset (class method)">.<strong>reset</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Resets signals and handlers back to their defaults.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#trap-class_method" title="trap (class method)">.<strong>trap</strong>(signal, command = nil, &amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Traps the given signal and runs the block when the signal is sent to this
process.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="reset-class_method">
  
    .<strong>reset</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Resets signals and handlers back to their defaults.  Any unprocessed
signals will be discarded.</p>

<p>This should be called after forking a processing in order to ensure that
signals continue to get processed.  <strong>Note</strong>, however, that
new handlers must get registered after forking.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


106
107
108
109
110
111
112
113
114
115
116
117
118
119
120</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/signal.rb', line 106</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset'>reset</span>
  <span class='comment'># Reset traps back to their default behavior.  Note that this *must*
</span>  <span class='comment'># be done first in order to prevent trap handlers from being called
</span>  <span class='comment'># while the wake pipe / listener are being reset.  If this is run
</span>  <span class='comment'># out of order, then it&#39;s possible for those callbacks to hit errors.
</span>  <span class='ivar'>@handlers</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_signal'>signal</span><span class='op'>|</span> <span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DEFAULT</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='rbrace'>}</span>

  <span class='comment'># Reset signals back to their empty state
</span>  <span class='ivar'>@listener</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@primary_signals</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
  <span class='ivar'>@secondary_signals</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
  <span class='ivar'>@wake_out</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='ivar'>@wake_in</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='ivar'>@wake_in</span><span class='comma'>,</span> <span class='ivar'>@wake_out</span> <span class='op'>=</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_pipe'>pipe</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="trap-class_method">
  
    .<strong>trap</strong>(signal, command = nil, &amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Traps the given signal and runs the block when the signal is sent to this
process.  This will run the block outside of the trap thread.</p>

<p>Only a single handler can be registered for a signal at any point.  If a
signal has already been trapped, a warning will be generated and the
previous handler for the signal will be returned.</p>

<p>See ::Signal#trap @ <a
href="http://ruby-doc.org/core-1.9.3/Signal.html#method-c-trap">ruby-doc.org/core-1.9.3/Signal.html#method-c-trap</a>
for more information.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/signal.rb', line 77</span>

<span class='kw'>def</span> <span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_command'>command</span>
    <span class='comment'># Command given for Ruby to interpret -- pass it directly onto Signal
</span>    <span class='ivar'>@handlers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span>
    <span class='op'>::</span><span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='comma'>,</span> <span class='id identifier rubyid_command'>command</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'># Ensure we&#39;re listening for signals
</span>    <span class='id identifier rubyid_listen'>listen</span>

    <span class='kw'>if</span> <span class='ivar'>@handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_signal'>signal</span><span class='rbracket'>]</span>
      <span class='const'><span class='object_link'><a href="../Chore.html" title="Chore (module)">Chore</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'><span class='object_link'><a href="../Chore.html#logger-class_method" title="Chore.logger (method)">logger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_signal'>signal</span><span class='embexpr_end'>}</span><span class='tstring_content'> signal has been overwritten:\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_caller'>caller</span> <span class='op'>*</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='comment'># Wrap handlers so they run in the listener thread
</span>    <span class='id identifier rubyid_signals'>signals</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="#PRIORITIES-constant" title="Chore::Signal::PRIORITIES (constant)">PRIORITIES</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_signal'>signal</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:secondary</span> <span class='op'>?</span> <span class='ivar'>@secondary_signals</span> <span class='op'>:</span> <span class='ivar'>@primary_signals</span>
    <span class='ivar'>@handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_signal'>signal</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_block'>block</span>
    <span class='op'>::</span><span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='id identifier rubyid_signal'>signal</span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='id identifier rubyid_signals'>signals</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_signal'>signal</span>
      <span class='id identifier rubyid_wakeup'>wakeup</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Sep 14 12:30:29 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.25 (ruby-2.3.0).
</div>

    </div>
  </body>
</html>