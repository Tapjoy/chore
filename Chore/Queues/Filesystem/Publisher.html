<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Chore::Queues::Filesystem::Publisher
  
    &mdash; Documentation by YARD 0.9.25
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Chore::Queues::Filesystem::Publisher";
  relpath = '../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Queues.html" title="Chore::Queues (module)">Queues</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Filesystem.html" title="Chore::Queues::Filesystem (module)">Filesystem</a></span></span>
     &raquo; 
    <span class="title">Publisher</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Chore::Queues::Filesystem::Publisher
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></li>
          
            <li class="next">Chore::Queues::Filesystem::Publisher</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/chore/queues/filesystem/publisher.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Publisher for writing jobs to the local filesystem. Useful for testing in
offline environments or when queuing implementations are irrelevent to the
task at hand, such as local development of new jobs.</p>


  </div>
</div>
<div class="tags">
  

</div>


  <h2>Constant Summary</h2>
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#CONFIG_DIR-constant" title="Chore::FilesystemQueue::CONFIG_DIR (constant)">FilesystemQueue::CONFIG_DIR</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#IN_PROGRESS_DIR-constant" title="Chore::FilesystemQueue::IN_PROGRESS_DIR (constant)">FilesystemQueue::IN_PROGRESS_DIR</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#NEW_JOB_DIR-constant" title="Chore::FilesystemQueue::NEW_JOB_DIR (constant)">FilesystemQueue::NEW_JOB_DIR</a></span></p>

  
  
  <h3 class="inherited">Constants inherited
     from <span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Publisher.html#DEFAULT_OPTIONS-constant" title="Chore::Publisher::DEFAULT_OPTIONS (constant)">Publisher::DEFAULT_OPTIONS</a></span></p>




  <h2>Instance Attribute Summary</h2>
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Publisher.html#options-instance_method" title="Chore::Publisher#options (method)">#options</a></span></p>


  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#filename-instance_method" title="#filename (instance method)">#<strong>filename</strong>(queue_name, job_name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>create a unique filename for a job in a queue based on queue name, job name
and date.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish-instance_method" title="#publish (instance method)">#<strong>publish</strong>(queue_name, job)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>use of mutex and file locking should make this both threadsafe and safe for
multiple processes to use the same queue directory simultaneously.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#config_dir-instance_method" title="Chore::FilesystemQueue#config_dir (method)">#config_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#config_value-instance_method" title="Chore::FilesystemQueue#config_value (method)">#config_value</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#in_progress_dir-instance_method" title="Chore::FilesystemQueue#in_progress_dir (method)">#in_progress_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#new_dir-instance_method" title="Chore::FilesystemQueue#new_dir (method)">#new_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#queue_dir-instance_method" title="Chore::FilesystemQueue#queue_dir (method)">#queue_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#queue_timeout-instance_method" title="Chore::FilesystemQueue#queue_timeout (method)">#queue_timeout</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#root_dir-instance_method" title="Chore::FilesystemQueue#root_dir (method)">#root_dir</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../../Publisher.html" title="Chore::Publisher (class)">Publisher</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Publisher.html#initialize-instance_method" title="Chore::Publisher#initialize (method)">#initialize</a></span>, <span class='object_link'><a href="../../Publisher.html#publish-class_method" title="Chore::Publisher.publish (method)">publish</a></span>, <span class='object_link'><a href="../../Publisher.html#reset_connection!-class_method" title="Chore::Publisher.reset_connection! (method)">reset_connection!</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <p class="notice">This class inherits a constructor from <span class='object_link'><a href="../../Publisher.html#initialize-instance_method" title="Chore::Publisher#initialize (method)">Chore::Publisher</a></span></p>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="filename-instance_method">
  
    #<strong>filename</strong>(queue_name, job_name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>create a unique filename for a job in a queue based on queue name, job name
and date</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35
36
37
38</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/publisher.rb', line 33</span>

<span class='kw'>def</span> <span class='id identifier rubyid_filename'>filename</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_job_name'>job_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_now'>now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y%m%d-%H%M%S-%6N</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_previous_attempts'>previous_attempts</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_pid'>pid</span>
  <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_new_dir'>new_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_job_name'>job_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_pid'>pid</span><span class='embexpr_end'>}</span><span class='tstring_content'>-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_now'>now</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='embexpr_end'>}</span><span class='tstring_content'>.job</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish-instance_method">
  
    #<strong>publish</strong>(queue_name, job)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>use of mutex and file locking should make this both threadsafe and safe for
multiple processes to use the same queue directory simultaneously.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/publisher.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>
  <span class='comment'># First try encoding the job to avoid writing empty job files if this fails
</span>  <span class='id identifier rubyid_encoded_job'>encoded_job</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_job'>encode_job</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_published'>published</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>while</span> <span class='op'>!</span><span class='id identifier rubyid_published'>published</span>
    <span class='comment'># keep trying to get a file with nothing in it meaning we just created it
</span>    <span class='comment'># as opposed to us getting someone else&#39;s file that hasn&#39;t been processed yet.
</span>    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='lbracket'>[</span><span class='symbol'>:class</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_EX</span> <span class='op'>|</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_NB</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>0</span>
        <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='id identifier rubyid_encoded_job'>encoded_job</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_published'>published</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Sep 14 12:30:29 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.25 (ruby-2.3.0).
</div>

    </div>
  </body>
</html>