<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Chore::Queues::Filesystem::Consumer
  
    &mdash; Documentation by YARD 0.9.25
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Chore::Queues::Filesystem::Consumer";
  relpath = '../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../_index.html">Index (C)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Queues.html" title="Chore::Queues (module)">Queues</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Filesystem.html" title="Chore::Queues::Filesystem (module)">Filesystem</a></span></span>
     &raquo; 
    <span class="title">Consumer</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Chore::Queues::Filesystem::Consumer
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName"><span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></li>
          
            <li class="next">Chore::Queues::Filesystem::Consumer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  <dl>
      <dt>Extended by:</dt>
      <dd><span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></dd>
  </dl>
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/chore/queues/filesystem/consumer.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This is the consuming side of the file system queue. This class consumes
jobs created by FilesystemPublisher#publish.  The root of the file system
queue is configured in Chore.config.fs_queue_root. In there a directory
will be created for each queue name. Each queue directory contains a
directory called “new” and one called “inprogress”.
FilesystemPublisher#publish creates new job files in the “new” directory.
This consumer polls that directory every 5 seconds for new jobs which are
moved to “inprogress”.</p>

<p>Once complete job files are deleted. If rejected they are moved back into
new and will be processed again.  This may not be the desired behavior long
term and we may want to add configuration to this class to allow more
creating failure handling and retrying.</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="EXPIRATION_CHECK_INTERVAL-constant" class="">EXPIRATION_CHECK_INTERVAL =
          <div class="docstring">
  <div class="discussion">
    
<p>The minimum number of seconds to allow to pass between checks for expired
jobs on the filesystem.</p>

<p>Since queue times are measured on the order of seconds, 1 second is the
smallest duration.  It also prevents us from burning a lot of CPU looking
at expired jobs when the consumer sleep interval is less than 1 second.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>1</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#CONFIG_DIR-constant" title="Chore::FilesystemQueue::CONFIG_DIR (constant)">FilesystemQueue::CONFIG_DIR</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#IN_PROGRESS_DIR-constant" title="Chore::FilesystemQueue::IN_PROGRESS_DIR (constant)">FilesystemQueue::IN_PROGRESS_DIR</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#NEW_JOB_DIR-constant" title="Chore::FilesystemQueue::NEW_JOB_DIR (constant)">FilesystemQueue::NEW_JOB_DIR</a></span></p>


  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#queue_timeout-instance_method" title="#queue_timeout (instance method)">#<strong>queue_timeout</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>The amount of time units of work can run before the queue considers them
timed out.</p>
</div></span>
  
</li>

    
  </ul>



  
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Consumer.html#queue_name-instance_method" title="Chore::Consumer#queue_name (method)">#queue_name</a></span></p>


  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cleanup-class_method" title="cleanup (class method)">.<strong>cleanup</strong>(expiration_time, new_dir, in_progress_dir)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Cleans up expired in-progress files by making them new again.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#each_file-class_method" title="each_file (class method)">.<strong>each_file</strong>(path, limit = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#file_info-class_method" title="file_info (class method)">.<strong>file_info</strong>(job_file)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Grabs the unique identifier for the job filename and the number of times
it&#39;s been attempted (also based on the filename).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#make_in_progress-class_method" title="make_in_progress (class method)">.<strong>make_in_progress</strong>(job, new_dir, in_progress_dir, queue_timeout)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Moves job file to inprogress directory and returns the full path if the job
was successfully locked by this consumer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#make_new_again-class_method" title="make_new_again (class method)">.<strong>make_new_again</strong>(job, new_dir, in_progress_dir)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Moves job file to new directory and returns the full path.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#complete-instance_method" title="#complete (instance method)">#<strong>complete</strong>(message_id, receipt_handle = nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Deletes the given message from filesystem queue.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#consume-instance_method" title="#consume (instance method)">#<strong>consume</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(queue_name, opts = {})  &#x21d2; Consumer </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of Consumer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reject-instance_method" title="#reject (instance method)">#<strong>reject</strong>(id)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Rejects the given message from the filesystem by <code>id</code>.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../../FilesystemQueue.html" title="Chore::FilesystemQueue (module)">FilesystemQueue</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../FilesystemQueue.html#config_dir-instance_method" title="Chore::FilesystemQueue#config_dir (method)">config_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#config_value-instance_method" title="Chore::FilesystemQueue#config_value (method)">config_value</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#in_progress_dir-instance_method" title="Chore::FilesystemQueue#in_progress_dir (method)">in_progress_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#new_dir-instance_method" title="Chore::FilesystemQueue#new_dir (method)">new_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#queue_dir-instance_method" title="Chore::FilesystemQueue#queue_dir (method)">queue_dir</a></span>, <span class='object_link'><a href="../../FilesystemQueue.html#root_dir-instance_method" title="Chore::FilesystemQueue#root_dir (method)">root_dir</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../../Consumer.html" title="Chore::Consumer (class)">Consumer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../Consumer.html#dupe_detector-instance_method" title="Chore::Consumer#dupe_detector (method)">#dupe_detector</a></span>, <span class='object_link'><a href="../../Consumer.html#duplicate_message%3F-instance_method" title="Chore::Consumer#duplicate_message? (method)">#duplicate_message?</a></span>, <span class='object_link'><a href="../../Consumer.html#provide_work-instance_method" title="Chore::Consumer#provide_work (method)">#provide_work</a></span>, <span class='object_link'><a href="../../Consumer.html#reset_connection!-class_method" title="Chore::Consumer.reset_connection! (method)">reset_connection!</a></span>, <span class='object_link'><a href="../../Consumer.html#running%3F-instance_method" title="Chore::Consumer#running? (method)">#running?</a></span>, <span class='object_link'><a href="../../Consumer.html#stop-instance_method" title="Chore::Consumer#stop (method)">#stop</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(queue_name, opts = {})  &#x21d2; <tt><span class='object_link'><a href="" title="Chore::Queues::Filesystem::Consumer (class)">Consumer</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of Consumer.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


127
128
129
130
131
132
133</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 127</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>

  <span class='ivar'>@in_progress_dir</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span>
  <span class='ivar'>@new_dir</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_new_dir'>new_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span>
  <span class='ivar'>@queue_timeout</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_queue_timeout'>queue_timeout</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="queue_timeout-instance_method">
  
    #<strong>queue_timeout</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>The amount of time units of work can run before the queue considers them
timed out.  For filesystem queues, this is the global default.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


125
126
127</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 125</span>

<span class='kw'>def</span> <span class='id identifier rubyid_queue_timeout'>queue_timeout</span>
  <span class='ivar'>@queue_timeout</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="cleanup-class_method">
  
    .<strong>cleanup</strong>(expiration_time, new_dir, in_progress_dir)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Cleans up expired in-progress files by making them new again.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 26</span>

<span class='kw'>def</span> <span class='id identifier rubyid_cleanup'>cleanup</span><span class='lparen'>(</span><span class='id identifier rubyid_expiration_time'>expiration_time</span><span class='comma'>,</span> <span class='id identifier rubyid_new_dir'>new_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_each_file'>each_file</span><span class='lparen'>(</span><span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_job_file'>job_file</span><span class='op'>|</span>
    <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='comma'>,</span> <span class='id identifier rubyid_timestamp'>timestamp</span> <span class='op'>=</span> <span class='id identifier rubyid_file_info'>file_info</span><span class='lparen'>(</span><span class='id identifier rubyid_job_file'>job_file</span><span class='rparen'>)</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_timestamp'>timestamp</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_expiration_time'>expiration_time</span>

    <span class='kw'>begin</span>
      <span class='id identifier rubyid_make_new_again'>make_new_again</span><span class='lparen'>(</span><span class='id identifier rubyid_job_file'>job_file</span><span class='comma'>,</span> <span class='id identifier rubyid_new_dir'>new_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span>
      <span class='comment'># File no longer exists; skip since it&#39;s been recovered by another
</span>      <span class='comment'># consumer
</span>    <span class='kw'>rescue</span> <span class='const'>ArgumentError</span>
      <span class='comment'># Move operation was attempted at same time as another consumer;
</span>      <span class='comment'># skip since the other process succeeded where this one didn&#39;t
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="each_file-class_method">
  
    .<strong>each_file</strong>(path, limit = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


94
95
96
97
98
99
100
101
102
103
104
105</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 94</span>

<span class='kw'>def</span> <span class='id identifier rubyid_each_file'>each_file</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_limit'>limit</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_count'>count</span> <span class='op'>=</span> <span class='int'>0</span>

  <span class='const'>Dir</span><span class='period'>.</span><span class='id identifier rubyid_foreach'>foreach</span><span class='lparen'>(</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_file'>file</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_file'>file</span><span class='period'>.</span><span class='id identifier rubyid_start_with?'>start_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

    <span class='kw'>yield</span> <span class='id identifier rubyid_file'>file</span>

    <span class='id identifier rubyid_count'>count</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_limit'>limit</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_count'>count</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_limit'>limit</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="file_info-class_method">
  
    .<strong>file_info</strong>(job_file)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Grabs the unique identifier for the job filename and the number of times
it&#39;s been attempted (also based on the filename)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


109
110
111
112</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 109</span>

<span class='kw'>def</span> <span class='id identifier rubyid_file_info'>file_info</span><span class='lparen'>(</span><span class='id identifier rubyid_job_file'>job_file</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='comma'>,</span> <span class='id identifier rubyid_timestamp'>timestamp</span><span class='comma'>,</span> <span class='op'>*</span> <span class='op'>=</span> <span class='id identifier rubyid_job_file'>job_file</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='id identifier rubyid_timestamp'>timestamp</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="make_in_progress-class_method">
  
    .<strong>make_in_progress</strong>(job, new_dir, in_progress_dir, queue_timeout)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Moves job file to inprogress directory and returns the full path if the job
was successfully locked by this consumer</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_make_in_progress'>make_in_progress</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='comma'>,</span> <span class='id identifier rubyid_new_dir'>new_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_queue_timeout'>queue_timeout</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_basename'>basename</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='comma'>,</span> <span class='op'>*</span> <span class='op'>=</span> <span class='id identifier rubyid_file_info'>file_info</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_from'>from</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_new_dir'>new_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>
  <span class='comment'># Add a timestamp to mark when the job was started
</span>  <span class='id identifier rubyid_to'>to</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_basename'>basename</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_previous_attempts'>previous_attempts</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='embexpr_end'>}</span><span class='tstring_content'>.job</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

  <span class='comment'># If the file is non-zero, this means it was successfully written to
</span>  <span class='comment'># by a publisher and we can attempt to move it to &quot;in progress&quot;.
</span>  <span class='comment'>#
</span>  <span class='comment'># There is a small window of time where the file can be zero, but
</span>  <span class='comment'># the publisher hasn&#39;t finished writing to the file yet.
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_zero?'>zero?</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='rparen'>)</span>
    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>r</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span>
      <span class='comment'># If the lock can&#39;t be obtained, that means it&#39;s been locked
</span>      <span class='comment'># by another consumer or the publisher of the file) -- don&#39;t
</span>      <span class='comment'># block and skip it
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_flock'>flock</span><span class='lparen'>(</span><span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_EX</span> <span class='op'>|</span> <span class='const'>File</span><span class='op'>::</span><span class='const'>LOCK_NB</span><span class='rparen'>)</span>
        <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_mv'>mv</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='comma'>,</span> <span class='id identifier rubyid_to'>to</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_to'>to</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_ctime'>ctime</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_queue_timeout'>queue_timeout</span>
    <span class='comment'># The file is empty (zero bytes) and enough time has passed since
</span>    <span class='comment'># the file was written that we can safely assume it will never
</span>    <span class='comment'># get written to be the publisher.
</span>    <span class='comment'>#
</span>    <span class='comment'># The scenario where this happens is when the publisher created
</span>    <span class='comment'># the file, but the process was killed before it had a chance to
</span>    <span class='comment'># actually write the data.
</span>    <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='rparen'>)</span>
    <span class='kw'>nil</span>
  <span class='kw'>end</span>
<span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span>
  <span class='comment'># File no longer exists; skip it since it&#39;s been picked up by
</span>  <span class='comment'># another consumer
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="make_new_again-class_method">
  
    .<strong>make_new_again</strong>(job, new_dir, in_progress_dir)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Moves job file to new directory and returns the full path</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


84
85
86
87
88
89
90
91
92</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 84</span>

<span class='kw'>def</span> <span class='id identifier rubyid_make_new_again'>make_new_again</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='comma'>,</span> <span class='id identifier rubyid_new_dir'>new_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_basename'>basename</span><span class='comma'>,</span> <span class='id identifier rubyid_previous_attempts'>previous_attempts</span> <span class='op'>=</span> <span class='id identifier rubyid_file_info'>file_info</span><span class='lparen'>(</span><span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_from'>from</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_in_progress_dir'>in_progress_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_job'>job</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_to'>to</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_new_dir'>new_dir</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_basename'>basename</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_previous_attempts'>previous_attempts</span> <span class='op'>+</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>.job</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='const'>FileUtils</span><span class='period'>.</span><span class='id identifier rubyid_mv'>mv</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='comma'>,</span> <span class='id identifier rubyid_to'>to</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_to'>to</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="complete-instance_method">
  
    #<strong>complete</strong>(message_id, receipt_handle = nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Deletes the given message from filesystem queue. Since the filesystem is
not a remote API, there is no notion of a “receipt handle”.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>message_id</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Unique ID of the message</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>receipt_handle</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Receipt handle of the message. Always nil for the filesystem consumer</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


169
170
171
172
173
174
175</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 169</span>

<span class='kw'>def</span> <span class='id identifier rubyid_complete'>complete</span><span class='lparen'>(</span><span class='id identifier rubyid_message_id'>message_id</span><span class='comma'>,</span> <span class='id identifier rubyid_receipt_handle'>receipt_handle</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='const'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'><span class='object_link'><a href="../../../Chore.html#logger-class_method" title="Chore.logger (method)">logger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Completing (deleting): </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message_id'>message_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='ivar'>@in_progress_dir</span><span class='comma'>,</span> <span class='id identifier rubyid_message_id'>message_id</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOENT</span>
  <span class='comment'># The job took too long to complete, was deemed expired, and moved
</span>  <span class='comment'># back into &quot;new&quot;.  Ignore.
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="consume-instance_method">
  
    #<strong>consume</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 135</span>

<span class='kw'>def</span> <span class='id identifier rubyid_consume'>consume</span>
  <span class='const'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'><span class='object_link'><a href="../../../Chore.html#logger-class_method" title="Chore.logger (method)">logger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Starting consuming file system queue </span><span class='embexpr_beg'>#{</span><span class='ivar'>@queue_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> in </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_queue_dir'>queue_dir</span><span class='lparen'>(</span><span class='id identifier rubyid_queue_name'>queue_name</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>while</span> <span class='id identifier rubyid_running?'>running?</span>
    <span class='kw'>begin</span>
      <span class='comment'># Move expired job files to new directory (so long as enough time has
</span>      <span class='comment'># passed since we last did this check)
</span>      <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@last_cleaned_at</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='ivar'>@last_cleaned_at</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&gt;=</span> <span class='const'><span class='object_link'><a href="#EXPIRATION_CHECK_INTERVAL-constant" title="Chore::Queues::Filesystem::Consumer::EXPIRATION_CHECK_INTERVAL (constant)">EXPIRATION_CHECK_INTERVAL</a></span></span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='period'>.</span><span class='id identifier rubyid_cleanup'>cleanup</span><span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>-</span> <span class='ivar'>@queue_timeout</span><span class='comma'>,</span> <span class='ivar'>@new_dir</span><span class='comma'>,</span> <span class='ivar'>@in_progress_dir</span><span class='rparen'>)</span>
        <span class='ivar'>@last_cleaned_at</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_found_files'>found_files</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='id identifier rubyid_handle_messages'>handle_messages</span> <span class='kw'>do</span> <span class='op'>|</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='op'>|</span>
        <span class='id identifier rubyid_found_files'>found_files</span> <span class='op'>=</span> <span class='kw'>true</span>
        <span class='kw'>yield</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='const'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span><span class='period'>.</span><span class='id identifier rubyid_logger'><span class='object_link'><a href="../../../Chore.html#logger-class_method" title="Chore.logger (method)">logger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>#consume: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span> <span class='op'>*</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
    <span class='kw'>ensure</span>
      <span class='id identifier rubyid_sleep'>sleep</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../../Chore.html" title="Chore (module)">Chore</a></span></span><span class='period'>.</span><span class='id identifier rubyid_config'><span class='object_link'><a href="../../../Chore.html#config-class_method" title="Chore.config (method)">config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_consumer_sleep_interval'>consumer_sleep_interval</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_found_files'>found_files</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reject-instance_method">
  
    #<strong>reject</strong>(id)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Rejects the given message from the filesystem by <code>id</code>. Currently
a noop</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


160
161
162</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/chore/queues/filesystem/consumer.rb', line 160</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reject'>reject</span><span class='lparen'>(</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Sep 14 12:30:29 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.25 (ruby-2.3.0).
</div>

    </div>
  </body>
</html>